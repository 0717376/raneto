---
Title: Оператор HAVING
Sort: 5
---

Вы уже хорошо освоили группировку, поэтому разобрать такой запрос будет нетрудно:

```sql
SELECT customer_id,
       SUM(total)
FROM invoice
GROUP BY customer_id; 
```

Данные сгруппировали по идентификатору покупателя и посчитали сумму выручки на каждого клиента. А что делать, если после группировки нужно оставить только те записи, в которых значение `SUM(total)` больше 41?

Если нужно получить срез данных после группировки, используют оператор `HAVING`. `HAVING` похож на оператор `WHERE`, но с отличием: `HAVING` всегда идёт после `GROUP BY`. У этих операторов есть и другие отличия — сравните с помощью таблицы.

Name|	Оператор WHERE|	Оператор HAVING
-- | -- | --
Когда используют|	Используют, чтобы получить срез данных перед группировкой или отфильтровать записи для агрегирующих функций|	Используют, чтобы получить срез данных после группировки
Можно применить без оператора `GROUP BY`|	Да|	Нет
Как сочетается с оператором `GROUP BY`|	Используют перед оператором `GROUP BY`|	Используют после оператора `GROUP BY`
Можно сочетать с агрегирующими функциями|	Нет|	Да

На сочетании с агрегирующими функциями нужно остановиться отдельно. Оператором `WHERE` можно отобрать нужные записи и применить к ним агрегирующую функцию, например `SUM`. 

```sql
SELECT SUM(total)
FROM invoice
WHERE total > 5; 
```

sum| 
--|
1797.81

Использовать агрегирующую функцию в условии после оператора `WHERE` нет смысла, ведь условие отбирает записи, которые станут аргументом агрегирующей функции. В случае с оператором `HAVING` наоборот — условие должно включать агрегирующие функции, иначе от такого среза будет немного пользы.

Сгруппировав данные по пользователям, можно применить оператор `HAVING`, чтобы отфильтровать нужные записи. Результат отсортирован по убыванию суммы выручки. 

```sql
SELECT customer_id,
       SUM(total)
FROM invoice
GROUP BY customer_id
HAVING SUM(total) > 41
ORDER BY SUM(total) DESC;
```

customer_id|	sum
--| --
6|	49.62
26|	47.62
57|	46.62
45|	45.62
46|	45.62
24|	43.62
28|	43.62
37|	43.62
7|	42.62
25|	42.62
44|	41.62